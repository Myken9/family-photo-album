name: PR Dynamic Environment

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]

jobs:
  deploy-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set PR environment variables
        id: vars
        run: |
          PR_ID=${{ github.event.pull_request.number }}
          PR_PORT=$((8000 + PR_ID))
          PR_URL="http://66.248.207.167:${PR_PORT}"
          
          echo "PR_ID=${PR_ID}" >> $GITHUB_ENV
          echo "PR_PORT=${PR_PORT}" >> $GITHUB_ENV
          echo "PR_URL=${PR_URL}" >> $GITHUB_ENV
          echo "pr_id=${PR_ID}" >> $GITHUB_OUTPUT
          echo "pr_port=${PR_PORT}" >> $GITHUB_OUTPUT
          echo "pr_url=${PR_URL}" >> $GITHUB_OUTPUT
          
          echo "âœ… PR Environment URL: ${PR_URL}"
          echo "ðŸ”„ Using port: ${PR_PORT} for PR #${PR_ID}"

      - name: Deploy PR environment
        if: github.event.action != 'closed'
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -e
            
            # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¸Ð· env
            PR_ID=${{ env.PR_ID }}
            PR_PORT=${{ env.PR_PORT }}
            
            echo "ðŸ“¦ Deploying PR #${PR_ID} on port ${PR_PORT}"
            
            PR_DIR=~/apps/pr-${PR_ID}
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð·Ð°Ð½ÑÑ‚ Ð»Ð¸ Ð¿Ð¾Ñ€Ñ‚
            echo "ðŸ” Checking port ${PR_PORT}..."
            if ss -tulpn | grep ":${PR_PORT} "; then
              echo "âš ï¸  Port ${PR_PORT} is already in use, trying to free it..."
              # ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ ÑÑ‚Ð¾Ñ‚ Ð¿Ð¾Ñ€Ñ‚
              docker ps --format '{{.Names}}' | grep -E "(app-|pr-)" | while read container; do
                if docker port "$container" 2>/dev/null | grep ":${PR_PORT}->"; then
                  echo "Stopping container $container using port ${PR_PORT}"
                  docker stop "$container" 2>/dev/null || true
                  docker rm "$container" 2>/dev/null || true
                fi
              done
            fi
            
            # Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ
            rm -rf ${PR_DIR}
            mkdir -p ${PR_DIR}
            cd ${PR_DIR}
            
            # ÐšÐ»Ð¾Ð½Ð¸Ñ€ÑƒÐµÐ¼ Ð²ÐµÑ‚ÐºÑƒ PR
            git clone -b ${{ github.head_ref }} git@github.com:Myken9/family-photo-album.git .
            
            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ .env Ñ„Ð°Ð¹Ð» Ñ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¼Ð¸
            cat > .env << EOF
            PR_ID=${PR_ID}
            PR_PORT=${PR_PORT}
            EOF
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹
            echo "ðŸ”§ Environment variables:"
            cat .env
            
            # ÐŸÐ¾Ð´Ð½Ð¸Ð¼Ð°ÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ñ ÑÐ²Ð½Ñ‹Ð¼ ÑƒÐºÐ°Ð·Ð°Ð½Ð¸ÐµÐ¼ .env Ñ„Ð°Ð¹Ð»Ð°
            docker compose --env-file .env -f docker-compose.yml -p pr-${PR_ID} up -d --build
            
            # Ð–Ð´ÐµÐ¼ Ð½ÐµÐ¼Ð½Ð¾Ð³Ð¾, Ñ‡Ñ‚Ð¾Ð±Ñ‹ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ð»ÑÑ
            sleep 5
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð½Ñ‹Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ Ð¸ Ð¸Ñ… Ð¿Ð¾Ñ€Ñ‚Ñ‹
            echo "ðŸ“Š Running containers:"
            docker ps --format "table {{.Names}}\t{{.Ports}}" | grep -E "(app-|pr-)" || true
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ð¾ Ð½Ð°Ñˆ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€
            echo "ðŸ” Checking app-${PR_ID} container:"
            docker port app-${PR_ID} || echo "Container not found or no ports exposed"
            
            echo "ðŸŒ PR environment should be available at: http://66.248.207.167:${PR_PORT}"

      - name: Comment PR with environment URL
        if: github.event.action != 'closed'
        uses: actions/github-script@v6
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const prPort = 8000 + prNumber;
            const prUrl = `http://66.248.207.167:${prPort}`;
            
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸš€ PR Environment deployed!\n\n**Access your environment here:**\nðŸ”— ${prUrl}\n\n*This environment will be automatically removed when the PR is closed.*`
            });

      - name: Remove PR environment
        if: github.event.action == 'closed'
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -e
            PR_ID=${{ github.event.pull_request.number }}
            PR_DIR=~/apps/pr-${PR_ID}
            
            echo "ðŸ—‘ï¸  Removing PR #${PR_ID} environment"
            
            if [ -d "${PR_DIR}" ]; then
              cd ${PR_DIR}
              docker compose -p pr-${PR_ID} down -v 2>/dev/null || true
              cd ..
              rm -rf ${PR_DIR}
            fi
            
            # Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€, ÐµÑÐ»Ð¸ Ð¾Ð½ Ð¾ÑÑ‚Ð°Ð»ÑÑ
            if docker ps -a --format '{{.Names}}' | grep -q "app-${PR_ID}"; then
              docker stop "app-${PR_ID}" 2>/dev/null || true
              docker rm "app-${PR_ID}" 2>/dev/null || true
            fi
            
            # Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÐµÑ‚ÑŒ ÐµÑÐ»Ð¸ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
            docker network rm pr-${PR_ID}_default 2>/dev/null || true
            docker network rm pr-pr-${PR_ID}_default 2>/dev/null || true
            
            echo "âœ… PR #${PR_ID} environment removed"