name: PR Dynamic Environment

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]

env:
  # –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –≤—Å–µ–≥–æ workflow
  PR_ID: ${{ github.event.pull_request.number }}
  PR_PORT: ${{ 8000 + github.event.pull_request.number }}

jobs:
  deploy-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set PR environment variables
        run: |
          echo "PR_ID=${{ github.event.pull_request.number }}" >> $GITHUB_ENV
          PR_PORT=$((8000 + ${{ github.event.pull_request.number }}))
          echo "PR_PORT=${PR_PORT}" >> $GITHUB_ENV
          PR_URL="http://66.248.207.167:${PR_PORT}"
          echo "PR_URL=${PR_URL}" >> $GITHUB_ENV
          echo "pr_url=${PR_URL}" >> $GITHUB_OUTPUT
          echo "‚úÖ PR Environment URL: ${PR_URL}"
          echo "üîÑ Using port: ${PR_PORT}"

      - name: Deploy PR environment
        if: github.event.action != 'closed'
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -e
            PR_ID=${{ env.PR_ID }}
            PR_PORT=${{ env.PR_PORT }}
            
            echo "üì¶ Deploying PR #${PR_ID} on port ${PR_PORT}"
            
            PR_DIR=~/apps/pr-${PR_ID}
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–Ω—è—Ç –ª–∏ –ø–æ—Ä—Ç
            if ss -tulpn | grep ":${PR_PORT} "; then
              echo "‚ö†Ô∏è  Port ${PR_PORT} is already in use, trying to free it..."
              # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —ç—Ç–æ—Ç –ø–æ—Ä—Ç
              docker ps --format '{{.Names}}' | grep pr- | while read container; do
                if docker port "$container" | grep ":${PR_PORT}->"; then
                  echo "Stopping container $container using port ${PR_PORT}"
                  docker stop "$container"
                  docker rm "$container"
                fi
              done
            fi
            
            # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
            rm -rf ${PR_DIR}
            mkdir -p ${PR_DIR}
            cd ${PR_DIR}
            
            # –ö–ª–æ–Ω–∏—Ä—É–µ–º –≤–µ—Ç–∫—É PR
            git clone -b ${{ github.head_ref }} git@github.com:Myken9/family-photo-album.git .
            
            # –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏
            echo "PR_ID=${PR_ID}" > .env
            echo "PR_PORT=${PR_PORT}" >> .env
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
            echo "üîß Environment variables:"
            cat .env
            
            # –ü–æ–¥–Ω–∏–º–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å —è–≤–Ω—ã–º —É–∫–∞–∑–∞–Ω–∏–µ–º .env —Ñ–∞–π–ª–∞
            docker compose --env-file .env -f docker-compose.yml -p pr-${PR_ID} up -d --build
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–ø—É—â–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∏ –∏—Ö –ø–æ—Ä—Ç—ã
            echo "üìä Running containers:"
            docker ps --format "table {{.Names}}\t{{.Ports}}"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –Ω–∞—à –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            echo "üîç Checking app-${PR_ID} container:"
            docker port app-${PR_ID}

      - name: Remove PR environment
        if: github.event.action == 'closed'
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -e
            PR_ID=${{ github.event.pull_request.number }}
            PR_DIR=~/apps/pr-${PR_ID}
            
            echo "üóëÔ∏è  Removing PR #${PR_ID} environment"
            
            if [ -d "${PR_DIR}" ]; then
              cd ${PR_DIR}
              docker compose -p pr-${PR_ID} down -v
              cd ..
              rm -rf ${PR_DIR}
            fi
            
            # –£–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –µ—Å–ª–∏ –æ–Ω –æ—Å—Ç–∞–ª—Å—è
            if docker ps -a --format '{{.Names}}' | grep -q "app-${PR_ID}"; then
              docker stop "app-${PR_ID}" || true
              docker rm "app-${PR_ID}" || true
            fi
            
            echo "‚úÖ PR #${PR_ID} environment removed"